pipeline {
    agent any

    stages {
        // ì €ì¥ì†Œë¥¼ ì²´í¬ì•„ì›ƒí•˜ëŠ” ê³µí†µ ë‹¨ê³„
        stage("Checkout") {
            steps {
                echo "Cleaning workspace and checking out repository..."
                deleteDir()
                git branch: "develop",
                    credentialsId: "gitlab-credentials",
                    url: "https://lab.ssafy.com/s13-final/S13P31D204.git"
            }
        }

        // ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì´í”„ë¼ì¸ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
        stage("Build & Deploy") {
            parallel {
                // =================================================================
                // Backend Pipeline
                // back/** ê²½ë¡œì— ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
                // =================================================================
                stage("Backend") {
                    when {
                        changeset "back/**"
                    }
                    environment {
                        IMAGE_NAME = "pola-backend"
                        IMAGE_TAG = "${BUILD_NUMBER}"
                        DEPLOY_NAMESPACE = "pola"
                    }
                    stages {
                        stage("Build") {
                            steps {
                                echo "Building Spring Boot application..."
                                dir("back/pola") {
                                    sh '''
                                        chmod +x ./gradlew
                                        ./gradlew clean bootJar -x test
                                    '''
                                }
                            }
                        }
                        stage("Docker Build") {
                            steps {
                                echo "Building Backend Docker image..."
                                dir("back/pola") {
                                    sh '''
                                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f Dockerfile .
                                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                                    '''
                                }
                            }
                        }
                        stage("Import to K3s") {
                            steps {
                                echo "Importing Backend Docker image to K3s..."
                                sh '''
                                    docker save ${IMAGE_NAME}:${IMAGE_TAG} | sudo k3s ctr images import -
                                    docker save ${IMAGE_NAME}:latest | sudo k3s ctr images import -
                                '''
                            }
                        }
                        stage("Deploy to K3s") {
                            steps {
                                echo "Deploying Backend to K3s cluster..."
                                sh '''
                                    # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ í˜„ì¬ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì—…ë°ì´íŠ¸
                                    sed -i "s|image: pola-backend:.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|g" infra/k8s/backend-deployment.yaml

                                    # Deployment ì ìš© (ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸)
                                    kubectl apply -f infra/k8s/backend-deployment.yaml

                                    # ë¡¤ë§ ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸° (ë¬´ì¤‘ë‹¨ ë°°í¬)
                                    kubectl rollout status deployment/backend -n ${DEPLOY_NAMESPACE} --timeout=5m

                                    # ë°°í¬ëœ ì´ë¯¸ì§€ í™•ì¸
                                    echo "=== Deployed Backend Image ==="
                                    kubectl get deployment backend -n ${DEPLOY_NAMESPACE} -o jsonpath='{.spec.template.spec.containers[0].image}'
                                    echo ""
                                '''
                            }
                        }
                        stage("Cleanup") {
                            steps {
                                echo "Cleaning up old Backend Docker images..."
                                sh '''
                                    docker images ${IMAGE_NAME} --format "{{.Tag}}" | grep -E "^[0-9]+$" | sort -nr | tail -n +4 | xargs -r -I {} docker rmi ${IMAGE_NAME}:{} || true
                                '''
                            }
                        }
                    }
                    post {
                        success {
                            echo "Backend deployment successful!"
                        }
                        failure {
                            echo "Backend deployment failed!"
                        }
                    }
                }

                // =================================================================
                // Frontend Pipeline
                // web/** ê²½ë¡œì— ë³€ê²½ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
                // =================================================================
                stage("Frontend") {
                    when {
                        changeset "web/**"
                    }
                    environment {
                        IMAGE_NAME = "pola-frontend"
                        IMAGE_TAG = "${BUILD_NUMBER}"
                        DEPLOY_NAMESPACE = "pola"
                    }
                    stages {
                        stage("Docker Build") {
                            steps {
                                echo "Building Frontend Docker image..."
                                dir("web/pola") {
                                    sh '''
                                        # ğŸ”¥ Secretì˜ ëª¨ë“  NEXT_PUBLIC_ í™˜ê²½ë³€ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
                                        echo "=== Loading all NEXT_PUBLIC_ environment variables from Secret ==="

                                        BUILD_ARGS=""

                                        # Secretì˜ ëª¨ë“  í‚¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (jq ì—†ì´ kubectlë§Œ ì‚¬ìš©)
                                        SECRET_KEYS=$(kubectl get secret frontend-build-env -n pola -o jsonpath='{.data}' | grep -oP '"NEXT_PUBLIC_[^"]*"' | tr -d '"')

                                        # ê° í‚¤ì— ëŒ€í•´ ê°’ì„ ê°€ì ¸ì™€ì„œ --build-argë¡œ ì¶”ê°€
                                        for key in $SECRET_KEYS; do
                                            value=$(kubectl get secret frontend-build-env -n pola -o jsonpath="{.data.$key}" | base64 -d)
                                            BUILD_ARGS="$BUILD_ARGS --build-arg $key=\"$value\""

                                            # ë””ë²„ê¹…: í™˜ê²½ë³€ìˆ˜ ë¡œë“œ í™•ì¸ (ê°’ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ)
                                            echo "âœ… Loaded: $key"
                                        done

                                        echo "=== Building Docker image with all environment variables ==="

                                        # Docker ë¹Œë“œ (ìë™ìœ¼ë¡œ ëª¨ë“  --build-arg ì „ë‹¬)
                                        docker build \
                                            --no-cache \
                                            $BUILD_ARGS \
                                            -t ${IMAGE_NAME}:${IMAGE_TAG} .
                                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                                    '''
                                }
                            }
                        }
                        stage("Import to K3s") {
                            steps {
                                echo "Importing Frontend Docker image to K3s..."
                                sh '''
                                    docker save ${IMAGE_NAME}:${IMAGE_TAG} | sudo k3s ctr images import -
                                    docker save ${IMAGE_NAME}:latest | sudo k3s ctr images import -
                                '''
                            }
                        }
                        stage("Deploy to K3s") {
                            steps {
                                echo "Deploying Frontend to K3s cluster..."
                                sh '''
                                    # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ í˜„ì¬ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì—…ë°ì´íŠ¸
                                    sed -i "s|image: pola-frontend:.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|g" infra/k8s/frontend-deployment.yaml

                                    # Deployment ì ìš© (ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸)
                                    kubectl apply -f infra/k8s/frontend-deployment.yaml

                                    # ë¡¤ë§ ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸° (ë¬´ì¤‘ë‹¨ ë°°í¬)
                                    kubectl rollout status deployment/frontend -n ${DEPLOY_NAMESPACE} --timeout=5m

                                    # ë°°í¬ëœ ì´ë¯¸ì§€ í™•ì¸
                                    echo "=== Deployed Frontend Image ==="
                                    kubectl get deployment frontend -n ${DEPLOY_NAMESPACE} -o jsonpath='{.spec.template.spec.containers[0].image}'
                                    echo ""
                                '''
                            }
                        }
                        stage("Cleanup") {
                            steps {
                                echo "Cleaning up old Frontend Docker images..."
                                sh '''
                                    docker images ${IMAGE_NAME} --format "{{.Tag}}" | grep -E "^[0-9]+$" | sort -nr | tail -n +4 | xargs -r -I {} docker rmi ${IMAGE_NAME}:{} || true
                                '''
                            }
                        }
                    }
                    post {
                        success {
                            echo "Frontend deployment successful!"
                        }
                        failure {
                            echo "Frontend deployment failed!"
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            echo "Pipeline finished."
        }
    }
}
